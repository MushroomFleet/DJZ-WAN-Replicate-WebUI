<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAN LoRA Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-white mb-4">
                üé¨ WAN LoRA Trainer
            </h1>
            <p class="text-slate-300 text-lg">
                Train your custom LoRA model with advanced video processing
            </p>
        </div>

        <!-- Main Form -->
        <div class="max-w-4xl mx-auto">
            <form id="trainForm" class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 shadow-2xl border border-white/20">
                <!-- Model Configuration -->
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold text-white mb-6 flex items-center">
                        <span class="bg-primary rounded-lg p-2 mr-3">üéØ</span>
                        Model Configuration
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Destination Model
                            </label>
                            <input 
                                type="text" 
                                id="destination" 
                                placeholder="username/model-name"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Trigger Word
                            </label>
                            <input 
                                type="text" 
                                id="trigger_word" 
                                value="TOK"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Model Type
                            </label>
                            <select 
                                id="model_type"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                                <option value="1.3b">1.3B Parameters</option>
                                <option value="14b" selected>14B Parameters</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Finetuning Type
                            </label>
                            <select 
                                id="finetuning_type"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                                <option value="text2video" selected>Text to Video</option>
                                <option value="image2video">Image to Video</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Video Clip Mode
                            </label>
                            <select 
                                id="video_clip_mode"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                                <option value="single_beginning">Single Beginning</option>
                                <option value="single_middle" selected>Single Middle</option>
                                <option value="multiple_overlapping">Multiple Overlapping</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Training Data -->
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold text-white mb-6 flex items-center">
                        <span class="bg-secondary rounded-lg p-2 mr-3">üìπ</span>
                        Training Data
                    </h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Input Video ZIP URL
                            </label>
                            <input 
                                type="url" 
                                id="input_video_zip" 
                                placeholder="https://your-video-zip-url.com/videos.zip"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                required
                            >
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="flex items-center space-x-3">
                                <input 
                                    type="checkbox" 
                                    id="autocaption" 
                                    checked
                                    class="w-5 h-5 text-primary bg-white/10 border-white/20 rounded focus:ring-primary focus:ring-2"
                                >
                                <label class="text-sm font-medium text-slate-200">
                                    Auto Caption
                                </label>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-200 mb-2">
                                    Caption Prefix
                                </label>
                                <input 
                                    type="text" 
                                    id="autocaption_prefix" 
                                    placeholder="Optional prefix"
                                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                >
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-200 mb-2">
                                    Caption Suffix
                                </label>
                                <input 
                                    type="text" 
                                    id="autocaption_suffix" 
                                    placeholder="Optional suffix"
                                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Parameters -->
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold text-white mb-6 flex items-center">
                        <span class="bg-green-600 rounded-lg p-2 mr-3">‚öôÔ∏è</span>
                        Training Parameters
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                LoRA Rank
                            </label>
                            <input 
                                type="number" 
                                id="lora_rank" 
                                value="32"
                                min="1" max="128"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Learning Rate
                            </label>
                            <input 
                                type="number" 
                                id="learning_rate" 
                                value="0.00002"
                                step="0.00001"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Weight Decay
                            </label>
                            <input 
                                type="number" 
                                id="weight_decay" 
                                value="0.0001"
                                step="0.0001"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Max Training Steps
                            </label>
                            <input 
                                type="number" 
                                id="max_training_steps" 
                                value="1000"
                                min="100"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Warmup Steps Budget
                            </label>
                            <input 
                                type="number" 
                                id="warmup_steps_budget" 
                                value="-1"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Seed
                            </label>
                            <input 
                                type="number" 
                                id="seed" 
                                value="-1"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                        </div>
                    </div>
                </div>

                <!-- Weights & Biases -->
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold text-white mb-6 flex items-center">
                        <span class="bg-orange-600 rounded-lg p-2 mr-3">üìä</span>
                        Weights & Biases
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                W&B Project Name
                            </label>
                            <input 
                                type="text" 
                                id="wandb_project" 
                                value="wan_train_replicate"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Save Interval
                            </label>
                            <input 
                                type="number" 
                                id="wandb_save_interval" 
                                value="500"
                                min="1"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-200 mb-2">
                                Sample Interval
                            </label>
                            <input 
                                type="number" 
                                id="wandb_sample_interval" 
                                value="250"
                                min="1"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            >
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button 
                        type="submit" 
                        id="submitBtn"
                        class="bg-gradient-to-r from-primary to-secondary hover:from-primary/80 hover:to-secondary/80 text-white font-bold py-4 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span id="submitText">üöÄ Start Training</span>
                        <span id="loadingSpinner" class="hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Training...
                        </span>
                    </button>
                </div>
            </form>

            <!-- Status Display -->
            <div id="statusDisplay" class="hidden mt-8 bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
                <h3 class="text-xl font-semibold text-white mb-4">Training Status</h3>
                <div id="statusContent" class="text-slate-300"></div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('trainForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const statusDisplay = document.getElementById('statusDisplay');
            const statusContent = document.getElementById('statusContent');
            
            // Show loading state
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            
            // Collect form data
            const formData = {
                destination: document.getElementById('destination').value,
                input: {
                    seed: parseInt(document.getElementById('seed').value),
                    lora_rank: parseInt(document.getElementById('lora_rank').value),
                    autocaption: document.getElementById('autocaption').checked,
                    trigger_word: document.getElementById('trigger_word').value,
                    weight_decay: parseFloat(document.getElementById('weight_decay').value),
                    learning_rate: parseFloat(document.getElementById('learning_rate').value),
                    wandb_project: document.getElementById('wandb_project').value,
                    input_video_zip: document.getElementById('input_video_zip').value,
                    autocaption_prefix: document.getElementById('autocaption_prefix').value,
                    autocaption_suffix: document.getElementById('autocaption_suffix').value,
                    max_training_steps: parseInt(document.getElementById('max_training_steps').value),
                    wandb_save_interval: parseInt(document.getElementById('wandb_save_interval').value),
                    warmup_steps_budget: parseInt(document.getElementById('warmup_steps_budget').value),
                    wandb_sample_interval: parseInt(document.getElementById('wandb_sample_interval').value),
                    model_type: document.getElementById('model_type').value,
                    finetuning_type: document.getElementById('finetuning_type').value,
                    video_clip_mode: document.getElementById('video_clip_mode').value
                }
            };
            
            try {
                // Send to backend
                const response = await fetch('/api/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    statusDisplay.classList.remove('hidden');
                    statusContent.innerHTML = `
                        <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-4">
                            <p class="font-semibold text-green-400">‚úÖ Training Started Successfully!</p>
                            <p class="mt-2">Training ID: <code class="bg-black/30 px-2 py-1 rounded">${result.id}</code></p>
                            <p class="mt-1">Status: <span class="text-yellow-400">${result.status}</span></p>
                            <a href="${result.urls?.get}" target="_blank" class="inline-block mt-3 text-blue-400 hover:text-blue-300 underline">
                                View Training Progress ‚Üí
                            </a>
                        </div>
                    `;
                } else {
                    throw new Error(result.error || 'Training failed');
                }
            } catch (error) {
                statusDisplay.classList.remove('hidden');
                statusContent.innerHTML = `
                    <div class="bg-red-500/20 border border-red-500/50 rounded-lg p-4">
                        <p class="font-semibold text-red-400">‚ùå Error</p>
                        <p class="mt-2 text-slate-300">${error.message}</p>
                    </div>
                `;
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>